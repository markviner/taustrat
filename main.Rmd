---
output:
  pdf_document:
    # latex_engine: lualatex
    latex_engine: xelatex
    number_sections: true
  html_document:
    theme: darkly 
    highlight: tango
linkcolor: blue

# mainfont: Linux Libertine O
mainfont: CMU Serif
# mainfont: EBGaramond08-Regular
fontsize: 12pt
# numbersections: true
numbersections: false
indent: true

header-includes:
- \usepackage{indentfirst}
- \usepackage{graphicx}
# - \usepackage{emoji}
- \usepackage{framed}
- \usepackage{rotating}
- \usepackage{subcaption}
- \usepackage{float}
- \usepackage{tikz}
- \usepackage[ruled,vlined,linesnumbered]{algorithm2e}

- \definecolor{lightred}{rgb}{1,0.8,0.8}
- \definecolor{lightgreen}{rgb}{0.8,1,0.8}
---

# Стратегия τ-reset (Базовая)

## Цель

Динамически перераспределять ликвидность в диапазоне $[P(1 - \Delta), P(1 +
\Delta)]$ каждые $\tau$ времени, минимизируя IL и максимизируя комиссионные
сборы.

## Параметры

- $\tau$: интервал перераспределения.

- $\Delta$: ширина диапазона.

- $\gamma$: комиссия пула.

- $W_0$: начальный капитал в токене $B$.  

## Формальный алгоритм

### Инициализация

1. В момент $t_0$:  

   - Текущая цена: $P_0$

   - Установить границы: $P_{\text{lower}}^{(0)} = P_0 (1 - \Delta), \quad
     P_{\text{upper}}^{(0)} = P_0 (1 + \Delta)$

   - Рассчитать ликвидность $L_0$ для $W_0$: $L_0 =
     \frac{W_0}{\sqrt{P_{\text{upper}}^{(0)}} - \sqrt{P_{\text{lower}}^{(0)}}}$

    - Внести ликвидность в пул.

### Шаг перераспределения (каждые $\tau$)

1. В момент $t_k$:  
   
   - Изъять текущую ликвидность $L_{k-1}$, получить токены $A$ и $B$.

   - Текущая цена: $P_k$.  

   - Обновить границы: $P_{\text{lower}}^{(k)} = P_k (1 - \Delta), \quad
     P_{\text{upper}}^{(k)} = P_k (1 + \Delta)$

   - Пересчитать ликвидность $L_k$ для капитала $W_k = \text{Стоимость}(A, B)$:
     $L_k = \frac{W_k (1 - \gamma)}{\sqrt{P_{\text{upper}}^{(k)}} -
     \sqrt{P_{\text{lower}}^{(k)}}}$

   - Внести $L_k$ в новый диапазон.

### Псевдокод

```{=latex}
\begin{algorithm}[H]
\textbf{Initialization:}\;
$t_0 \leftarrow \text{initial time}$\;
$P_0 \leftarrow \text{current price}$\;
$P_{\text{lower}}^{(0)} \leftarrow P_0 (1 - \Delta)$\;
$P_{\text{upper}}^{(0)} \leftarrow P_0 (1 + \Delta)$\;
$L_0 \leftarrow \frac{W_0}{\sqrt{P_{\text{upper}}^{(0)}} - \sqrt{P_{\text{lower}}^{(0)}}}$\;
\text{Add liquidity } $L_0$ \text{ to } $[P_{\text{lower}}^{(0)}, P_{\text{upper}}^{(0)}]$\;

\While{\text{strategy is active}}{
    \text{Wait } $\tau$\;
    $t_k \leftarrow \text{current time}$\;
    \text{Withdraw liquidity } $L_{k-1}$\;
    $P_k \leftarrow \text{current price}$\;
    $P_{\text{lower}}^{(k)} \leftarrow P_k (1 - \Delta)$\;
    $P_{\text{upper}}^{(k)} \leftarrow P_k (1 + \Delta)$\;
    $W_k \leftarrow \text{Value}(A, B) \times (1 - \gamma)$\;
    $L_k \leftarrow \frac{W_k}{\sqrt{P_{\text{upper}}^{(k)}} - \sqrt{P_{\text{lower}}^{(k)}}}$\;
    \text{Add liquidity } $L_k$ \text{ to } $[P_{\text{lower}}^{(k)}, P_{\text{upper}}^{(k)}]$\;
}
\end{algorithm}
```

- **Строка 4-5**: Инициализация начального диапазона на основе стартовой цены.  

- **Строка 12**: Перерасчет капитала с учетом комиссий $\gamma$.

- **Строка 14**: Динамическое обновление ликвидности для компенсации IL.  

# Volume-Adjusted τ-Reset Liquidity Strategy

Данная стратегия является модификацией классической  $\tau$-reset стратегии
<!-- Тут добавить ссылку на статью ( в рефы ) --> управления ликвидностью в
Uniswap V3.

## Цель

Адаптировать диапазон ликвидности под рыночную активность, снижая частоту
выхода за границы диапазона при высокой активности и концентрируя ликвидность
при низкой.

## Параметры

| Symbol      | Название           | Тип           | Описание                                         |
| ----------- | ------------------ | ------------- | ------------------------------------------------ |
| $\tau$      | reset interval     | int (в часах) | Интервал ребалансировки                          |
| $\delta_0$  | base delta         | float         | Базовая ширина диапазона                         |
| $k$         | volume sensitivity | float         | Коэффициент чувствительности диапазона к объёму  |
| $\gamma$    | fee                | float         | Комиссия пула Uniswap V3 (в долях)               |
| $W_0$       | initial capital    | float         | Начальный капитал в стейблкоине (например, USDC) |
| $h$         | volume window      | int           | Длина окна (в часах) для усреднения объёма       |

## Формальный алгоритм

### Инициализация

* В начальный момент времени $t_0$, определяем цену пула:

  $$
  P_0 = \text{price}(t_0)
  $$

* Устанавливаем начальный диапазон:

  $$
  P_{\text{lower}}^{(0)} = P_0 \cdot (1 - \delta_0), \quad
  P_{\text{upper}}^{(0)} = P_0 \cdot (1 + \delta_0)
  $$

* Рассчитываем ликвидность, которая может быть внесена:

  $$
  L_0 = \frac{W_0}{\sqrt{P_{\text{upper}}^{(0)}} - \sqrt{P_{\text{lower}}^{(0)}}}
  $$

### Ребалансировка (каждые $\tau$ часов)

В момент времени $t$, если $t - t_{\text{last reset}} \geq \tau$, происходит следующее:

#### (1) Адаптация ширины диапазона

* Объём в текущем observation:

  $$
  V_t = \text{volume}(t)
  $$

* Средний объём за последние $h$ часов:

  $$
  \bar{V}_t = \frac{1}{h} \sum_{i = t-h+1}^{t} \text{volume}(i)
  $$

* Относительное отклонение объёма:

  $$
  R_t = \frac{V_t}{\bar{V}_t}
  $$

* Обновлённая ширина диапазона:

  $$
  \delta_t = \min\left(0.2, \max\left(0.01, \delta_0 + k \cdot (R_t - 1)\right)\right)
  $$

#### (2) Обновление диапазона

$$
P_{\text{lower}}^{(t)} = P_t \cdot (1 - \delta_t), \quad
P_{\text{upper}}^{(t)} = P_t \cdot (1 + \delta_t)
$$

#### (3) Имперманентные потери (IL)

Если цена изменилась с предыдущей ребалансировки ($P_{\text{prev}} \rightarrow
P_t$), то применяются имперманентные потери:

$$
\text{IL}(P_{\text{prev}}, P_t) = \left(\frac{2\sqrt{P_t/P_{\text{prev}}}}{1 + P_t/P_{\text{prev}}} - 1\right)
$$

#### (4) Обновление капитала

$$
W_t = W_{t-1} \cdot (1 + \text{IL}) \cdot (1 - \gamma)
$$

#### (5) Расчёт ликвидности для нового диапазона

$$
L_t = \frac{W_t}{\sqrt{P_{\text{upper}}^{(t)}} - \sqrt{P_{\text{lower}}^{(t)}}}
$$

---

## Отличие от классической $\tau$-reset strategy

| Компонент                  | VolumeAdjusted τ-reset              | TauResetStrategy из fractal-defi |
| -------------------------- | ----------------------------------- | -------------------------------- |
| Δ (ширина диапазона)       | **динамическая**: зависит от объёма | **фиксированная**                |
| Основание для адаптации    | Скользящий средний объём            | Нет адаптации                    |
| IL (имперманентные потери) | Учитываются явно через формулу      | Учитываются косвенно             |
| Реакция на рынок           | Гибкая, учитывает активность        | Жёстко фиксированная             |

## Ограничения

* Ликвидность считается пропорционально капиталу, упрощая реальные расчёты токенов A и B.

* Все средства всегда реинвестируются при ребалансировке.

* Цена пула извлекается как агрегированная (напр., из Binance или TWAP Uniswap).

* Объём измеряется в USD-эквиваленте и сравнивается по rolling window.

* Нет исполнения частичных выводов или дельта-хеджирования.
